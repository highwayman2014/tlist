
&НаКлиенте
Процедура ВыполнитьОтчет(Команда)
	ВыполнитьОтчетНаСервере(тд);
	//тд.Показать();
КонецПроцедуры


&НаСервере
Процедура ВыполнитьОтчетНаСервере(тд)
	
	//тд = новый ТабличныйДокумент;
	
	тд.Очистить();

	
	макет = РеквизитФормыВЗначение("Отчет").получитьМакет("Макет");
	облЗаголовок = макет.ПолучитьОбласть("Заголовок");
	облСтрока = макет.ПолучитьОбласть("Строка");
	облПодвал = макет.ПолучитьОбласть("Подвал");
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
                   |    Задание.Ссылка КАК Задание,
                   |    Задание.ТекстЗадания,
                   |    Задание.Дата,
                   |    Задание.НачалоПлан,
                   |    Задание.ОкончаниеПлан,
                   |    Задание.ВремяПлан,
                   |    Задание.НачалоФакт,
                   |    Задание.ОкончаниеФакт,
                   |    Задание.ВремяФакт,
                   |    Задание.ДатаПриемки,
                   |    ВЫБОР
                   |        КОГДА Задание.ВремяПлан < Задание.ВремяФакт
                   |            ТОГДА Задание.ВремяПлан
                   |        ИНАЧЕ Задание.ВремяФакт
                   |    КОНЕЦ КАК МинимальноеВремя,
                   |    Задание.СписокИсполнителей.(
                   |        Исполнитель
                   |    ),
                   |    Задание.ТрудозатратыИсполнителей.(
                   |        Комментарий
                   |    )
                   |ИЗ
                   |    Документ.Задание КАК Задание
                   |ГДЕ
                   |    Задание.Статус = &СтатусПринято
                   |    И Задание.ДатаПриемки МЕЖДУ &НачалоПериода И &КонецПериода
                   |    И Задание.Проект В ИЕРАРХИИ(&Проект)";
	
	Запрос.УстановитьПараметр("СтатусПринято",перечисления.Статус.Принято);				
	Запрос.УстановитьПараметр("НачалоПериода",НачалоДня(Отчет.НачалоПериода));				
	Запрос.УстановитьПараметр("КонецПериода",КонецДня(Отчет.КонецПериода));	
	Запрос.УстановитьПараметр("Проект",Отчет.Проект);				
	
	выборка = Запрос.Выполнить().Выбрать();
	тд.вывести(облЗаголовок);
	
	ВремяПлан = 0;
	ВремяФакт = 0;
	МинимальноеВремя = 0;
	пока выборка.Следующий() цикл
		 облСтрока.Параметры.Заполнить(выборка);
         
         тчКомментарии = выборка.ТрудозатратыИсполнителей.выбрать();
         Комментарии = " (";
         ПервыйРаз = Истина;
         Пока тчКомментарии.следующий() Цикл
             Если ЗначениеЗаполнено(тчКомментарии.Комментарий) Тогда
                 Комментарии = Комментарии + ?(ПервыйРаз,"",", ")+СокрЛП(тчКомментарии.Комментарий);
                 ПервыйРаз = Ложь;
             КонецЕсли; 
         КонецЦикла;
         Если НЕ ПервыйРаз Тогда
             облСтрока.Параметры.ТекстЗадания = облСтрока.Параметры.ТекстЗадания + Комментарии + ")";
         КонецЕсли; 
         
		 тч = выборка.СписокИсполнителей.выбрать();
		 Исполнители = "";
		 пока тч.следующий() цикл
			  Исполнители = Исполнители+?(Исполнители = "","",символы.ПС)+тч.Исполнитель;
		 КонецЦикла;
		 облСтрока.Параметры.Исполнители = Исполнители;
		 тд.вывести(облСтрока);
		 ВремяПлан = ВремяПлан + выборка.ВремяПлан;
		 ВремяФакт = ВремяФакт + выборка.ВремяФакт;
		 МинимальноеВремя = МинимальноеВремя + выборка.МинимальноеВремя;
	 КонецЦикла;
	 
	облПодвал.параметры.ВремяПлан = ВремяПлан; 
	облПодвал.параметры.ВремяФакт = ВремяФакт; 
	облПодвал.параметры.МинимальноеВремя = МинимальноеВремя; 
	тд.вывести(облПодвал);
	
	тд.толькоПросмотр = Истина;	
	тд.ОтображатьЗаголовки=Ложь;
	тд.ОтображатьСетку=Ложь;
	
КонецПроцедуры
